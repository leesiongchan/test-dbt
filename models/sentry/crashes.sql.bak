{% set report_types = ["background", "crash"] %}

WITH
stg_events AS (
	SELECT * FROM {{ source('public', 'events') }}
),
stg_events_tags AS (
	SELECT * FROM {{ source('public', 'events_tags') }}
),
events AS (
	SELECT * FROM stg_events INNER JOIN stg_events_tags ON stg_events_tags._airbyte_ab_id = stg_events._airbyte_ab_id WHERE stg_events_tags.key = 'ReportType'
)
{% for report_type in report_typs %}
{{ report_Type }}_crashes AS (
	SELECT * FROM events WHERE value = '{{ report_type }}'
)
{% endfor %}
final as (
	SELECT
		{% for report_type in report_types %}
		COUNT({{ report_type }}_crashes) AS total_{{ report_type }}_crashes
		{% endfor %}
	FROM events
	{% for report_type in report_types %}
	INNER JOIN {{ report_type }}_crashes ON {{ report_type }}_crashes.id = events.id
	{% endfor %}
)

